<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>fastdebug - 0009_fastai_small_models_road_to_the_top_part_2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="fastdebug - 0009_fastai_small_models_road_to_the_top_part_2">
<meta property="og:description" content="This is part 2 of the Road to the Top series, in which I show the process I used to tackle the Paddy Doctor competition, leading to four 1st place submissions.">
<meta property="og:site-name" content="fastdebug">
<meta name="twitter:title" content="fastdebug - 0009_fastai_small_models_road_to_the_top_part_2">
<meta name="twitter:description" content="This is part 2 of the Road to the Top series, in which I show the process I used to tackle the Paddy Doctor competition, leading to four 1st place submissions.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">fastdebug</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">0009_fastai_small_models_road_to_the_top_part_2</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Learning fastai with joy</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Interesting_fastai</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Interesting_fastai/the_origin_of_apl .html" class="sidebar-item-text sidebar-link">0001_The_origin_of_APL</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Interesting_fastai/Interesting_things_fastai.html" class="sidebar-item-text sidebar-link">Interesting_things_fastai.html</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">demos</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/intro_fastdebug.html" class="sidebar-item-text sidebar-link">Introducing fastdebug</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/tour.html" class="sidebar-item-text sidebar-link">0000_tour</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore_meta_delegates.html" class="sidebar-item-text sidebar-link">0001_Fastcore.meta.delegates</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/signature_from_callable.html" class="sidebar-item-text sidebar-link">0002_signature_from_callable</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/explore_document_fixsigmeta_prepostinitmeta_autoinit.html" class="sidebar-item-text sidebar-link">03_FixSigMeta_PrePostInitMeta_AutoInit</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta._rm_self.html" class="sidebar-item-text sidebar-link">04_rm_self</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta.test_sig.html" class="sidebar-item-text sidebar-link">05_test_sig</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta.newchkmeta.html" class="sidebar-item-text sidebar-link">06_NewChkMeta</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta.bypassnewmeta.html" class="sidebar-item-text sidebar-link">07_BypassNewMeta</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/use_kwargs_dict.html" class="sidebar-item-text sidebar-link">08_use_kwargs_dict</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/funcs_kwargs.html" class="sidebar-item-text sidebar-link">09_method_funcs_kwargs</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore_meta_summary.html" class="sidebar-item-text sidebar-link">0010_fastcore_meta_summary</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastdb.html" class="sidebar-item-text sidebar-link">0011_Fastdb</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore_foundation_l.html" class="sidebar-item-text sidebar-link">0012_fastcore_foundation_L</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">fastai_notebooks</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_is_it_a_bird.html" class="sidebar-item-text sidebar-link">0001_fastai_Is it a bird? Creating a model from your own data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_saving_a_basic_fastai_model.html" class="sidebar-item-text sidebar-link">0002_fastai_saving_a_basic_fastai_model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_which_image_model_best.html" class="sidebar-item-text sidebar-link">0003_fastai_which_image_model_best</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_how_neuralnet_work.html" class="sidebar-item-text sidebar-link">0004_fastai_how_neuralnet_work</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_linear_neuralnet_scratch.html" class="sidebar-item-text sidebar-link">0005_fastai_linear_neuralnet_scratch</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_why_should_use_framework.html" class="sidebar-item-text sidebar-link">0006_fastai_why_should_use_framework</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_how_random_forests_really_work.html" class="sidebar-item-text sidebar-link">0007_fastai_how_random_forests_really_work</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_first_steps_road_to_top_part_1.html" class="sidebar-item-text sidebar-link">0008_fastai_first_steps_road_to_top_part_1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_small_models_road_to_the_top_part_2.html" class="sidebar-item-text sidebar-link active">0009_fastai_small_models_road_to_the_top_part_2</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_scaling_up_road_to_top_part_3.html" class="sidebar-item-text sidebar-link">0010_fastai_scaling_up_road_to_top_part_3</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_multi_target_road_to_top_part_4.html" class="sidebar-item-text sidebar-link">0011_fastai_multi_target_road_to_top_part_4</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_using_nbdev_export_in_kaggle_notebook.html" class="sidebar-item-text sidebar-link">0012_fastai_using_nbdev_export_in_kaggle_notebook</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/best_vision_models_for_fine_tuning.html" class="sidebar-item-text sidebar-link">0013_best_vision_models_for_fine_tuning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/iterate_like_grandmaster.html" class="sidebar-item-text sidebar-link">0014_iterate_like_grandmaster</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/getting_started_with_nlp_for_absolute_beginner.html" class="sidebar-item-text sidebar-link">0015_getting_started_with_nlp_for_absolute_beginner</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/collaborative_filtering_deep_dive.html" class="sidebar-item-text sidebar-link">0016_collaborative_filtering_deep_dive</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptmatmul.html" class="sidebar-item-text sidebar-link">0017_fastai_pt2_2019_matmul</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptexports.html" class="sidebar-item-text sidebar-link">0018_fastai_pt2_2019_exports</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptlectureintro.html" class="sidebar-item-text sidebar-link">0019_fastai_pt2_2019_lecture1_intro</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptsource_explained.html" class="sidebar-item-text sidebar-link">0020_fastai_pt2_2019_source_explained</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptfully_connected.html" class="sidebar-item-text sidebar-link">0021_fastai_pt2_2019_fully_connected</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptwhy_sqrt5.html" class="sidebar-item-text sidebar-link">0022_fastai_pt2_2019_why_sqrt5</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">questions</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../questions/question_anno_dict.html" class="sidebar-item-text sidebar-link">00_quesolved_anno_dict</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#going-faster" id="toc-going-faster" class="nav-link active" data-scroll-target="#going-faster">Going faster</a>
  <ul class="collapse">
  <li><a href="#why-kaggle-gpu-is-much-slower-for-training-and-how-does-fastai-to-fix-it-with-resize_images" id="toc-why-kaggle-gpu-is-much-slower-for-training-and-how-does-fastai-to-fix-it-with-resize_images" class="nav-link" data-scroll-target="#why-kaggle-gpu-is-much-slower-for-training-and-how-does-fastai-to-fix-it-with-resize_images">why kaggle gpu is much slower for training and how does fastai to fix it with <code>resize_images</code></a></li>
  <li><a href="#how-to-create-a-new-folder-with-path" id="toc-how-to-create-a-new-folder-with-path" class="nav-link" data-scroll-target="#how-to-create-a-new-folder-with-path">how to create a new folder with <code>Path</code></a></li>
  <li><a href="#how-to-resize-all-images-including-those-in-subfolders-of-train_images-folder-and-save-them-into-a-new-destination-folder-max_size-256-does-shrink-the-total-size-by-4-but-question-how-jeremy-pick-256-not-250" id="toc-how-to-resize-all-images-including-those-in-subfolders-of-train_images-folder-and-save-them-into-a-new-destination-folder-max_size-256-does-shrink-the-total-size-by-4-but-question-how-jeremy-pick-256-not-250" class="nav-link" data-scroll-target="#how-to-resize-all-images-including-those-in-subfolders-of-train_images-folder-and-save-them-into-a-new-destination-folder-max_size-256-does-shrink-the-total-size-by-4-but-question-how-jeremy-pick-256-not-250">how to resize all images (including those in subfolders) of <code>train_images</code> folder and save them into a new destination folder; max_size = 256 does shrink the total size by 4+, but question: how Jeremy pick 256 not 250;</a></li>
  <li><a href="#how-to-create-an-image-dataloaders-using-the-resized-image-folder-and-specify-the-resize-for-each-image-item-how-to-display-just-3-images-in-a-batch" id="toc-how-to-create-an-image-dataloaders-using-the-resized-image-folder-and-specify-the-resize-for-each-image-item-how-to-display-just-3-images-in-a-batch" class="nav-link" data-scroll-target="#how-to-create-an-image-dataloaders-using-the-resized-image-folder-and-specify-the-resize-for-each-image-item-how-to-display-just-3-images-in-a-batch">how to create an image dataloaders using the resized image folder and specify the resize for each image item; how to display just 3 images in a batch</a></li>
  <li><a href="#how-to-wrap-dataloaders-creation-model-creation-fine-tuning-together-in-a-func-train-and-return-the-trained-model-how-use-model-architecture-item-transforms-and-batch-transforms-and-num-of-epochs-as-the-params-of-the-train-function" id="toc-how-to-wrap-dataloaders-creation-model-creation-fine-tuning-together-in-a-func-train-and-return-the-trained-model-how-use-model-architecture-item-transforms-and-batch-transforms-and-num-of-epochs-as-the-params-of-the-train-function" class="nav-link" data-scroll-target="#how-to-wrap-dataloaders-creation-model-creation-fine-tuning-together-in-a-func-train-and-return-the-trained-model-how-use-model-architecture-item-transforms-and-batch-transforms-and-num-of-epochs-as-the-params-of-the-train-function">how to wrap dataloaders creation, model creation, fine tuning together in a func <code>train</code> and return the trained model; how use model architecture, item transforms, and batch transforms, and num of epochs as the params of the <code>train</code> function;</a></li>
  </ul></li>
  <li><a href="#a-convnext-model" id="toc-a-convnext-model" class="nav-link" data-scroll-target="#a-convnext-model">A ConvNeXt model</a>
  <ul class="collapse">
  <li><a href="#how-to-tell-whether-a-larger-pretrained-model-would-affect-our-training-speed-by-reading-gpu-and-cpu-usage-bar-why-to-pick-convnext_small-for-our-second-model" id="toc-how-to-tell-whether-a-larger-pretrained-model-would-affect-our-training-speed-by-reading-gpu-and-cpu-usage-bar-why-to-pick-convnext_small-for-our-second-model" class="nav-link" data-scroll-target="#how-to-tell-whether-a-larger-pretrained-model-would-affect-our-training-speed-by-reading-gpu-and-cpu-usage-bar-why-to-pick-convnext_small-for-our-second-model">How to tell whether a larger pretrained model would affect our training speed by reading GPU and CPU usage bar? why to pick convnext_small for our second model;</a></li>
  <li><a href="#how-to-load-and-use-a-new-pretrained-model-in-fastai" id="toc-how-to-load-and-use-a-new-pretrained-model-in-fastai" class="nav-link" data-scroll-target="#how-to-load-and-use-a-new-pretrained-model-in-fastai">how to load and use a new pretrained model in fastai</a></li>
  </ul></li>
  <li><a href="#preprocessing-experiments" id="toc-preprocessing-experiments" class="nav-link" data-scroll-target="#preprocessing-experiments">Preprocessing experiments</a>
  <ul class="collapse">
  <li><a href="#question-why-trying-different-ways-of-cutting-images-could-possibly-improve-model-performance-what-are-the-proper-options-for-cutting-images-or-preparing-images" id="toc-question-why-trying-different-ways-of-cutting-images-could-possibly-improve-model-performance-what-are-the-proper-options-for-cutting-images-or-preparing-images" class="nav-link" data-scroll-target="#question-why-trying-different-ways-of-cutting-images-could-possibly-improve-model-performance-what-are-the-proper-options-for-cutting-images-or-preparing-images">question: why trying different ways of cutting images could possibly improve model performance; what are the proper options for cutting images or preparing images</a></li>
  <li><a href="#how-to-try-cutting-image-with-crop-instead-of-squish" id="toc-how-to-try-cutting-image-with-crop-instead-of-squish" class="nav-link" data-scroll-target="#how-to-try-cutting-image-with-crop-instead-of-squish">how to try cutting image with <code>crop</code> instead of <code>squish</code></a></li>
  <li><a href="#what-is-transform-image-with-padding-and-how-does-it-differ-from-squish-and-crop" id="toc-what-is-transform-image-with-padding-and-how-does-it-differ-from-squish-and-crop" class="nav-link" data-scroll-target="#what-is-transform-image-with-padding-and-how-does-it-differ-from-squish-and-crop">what is transform image with padding and how does it differ from squish and crop</a></li>
  <li><a href="#question-how-resize256-192-and-size171-128-are-determined" id="toc-question-how-resize256-192-and-size171-128-are-determined" class="nav-link" data-scroll-target="#question-how-resize256-192-and-size171-128-are-determined">question: how <code>resize(256, 192)</code> and <code>size(171, 128)</code> are determined</a></li>
  </ul></li>
  <li><a href="#test-time-augmentation" id="toc-test-time-augmentation" class="nav-link" data-scroll-target="#test-time-augmentation">Test time augmentation</a>
  <ul class="collapse">
  <li><a href="#how-does-test-time-augmentation-tta-work-question-what-is-the-rationale-behind-tta" id="toc-how-does-test-time-augmentation-tta-work-question-what-is-the-rationale-behind-tta" class="nav-link" data-scroll-target="#how-does-test-time-augmentation-tta-work-question-what-is-the-rationale-behind-tta">how does test time augmentation TTA work; question: what is the rationale behind TTA</a></li>
  <li><a href="#how-to-check-the-performance-of-our-model-on-validation-set" id="toc-how-to-check-the-performance-of-our-model-on-validation-set" class="nav-link" data-scroll-target="#how-to-check-the-performance-of-our-model-on-validation-set">how to check the performance of our model on validation set</a></li>
  <li><a href="#how-to-display-the-transformations-which-have-been-done-to-a-single-image-in-the-training-set" id="toc-how-to-display-the-transformations-which-have-been-done-to-a-single-image-in-the-training-set" class="nav-link" data-scroll-target="#how-to-display-the-transformations-which-have-been-done-to-a-single-image-in-the-training-set">how to display the transformations which have been done to a single image in the training set</a></li>
  <li><a href="#how-to-do-tta-on-validation-set" id="toc-how-to-do-tta-on-validation-set" class="nav-link" data-scroll-target="#how-to-do-tta-on-validation-set">how to do TTA on validation set</a></li>
  <li><a href="#how-to-calc-the-error-rate-of-the-tta_preds" id="toc-how-to-calc-the-error-rate-of-the-tta_preds" class="nav-link" data-scroll-target="#how-to-calc-the-error-rate-of-the-tta_preds">how to calc the error rate of the tta_preds</a></li>
  </ul></li>
  <li><a href="#scaling-up" id="toc-scaling-up" class="nav-link" data-scroll-target="#scaling-up">Scaling up</a>
  <ul class="collapse">
  <li><a href="#how-to-scale-up-on-the-model-using-padding-and-the-tta-approach-in-terms-of-image-size-and-epoch-number" id="toc-how-to-scale-up-on-the-model-using-padding-and-the-tta-approach-in-terms-of-image-size-and-epoch-number" class="nav-link" data-scroll-target="#how-to-scale-up-on-the-model-using-padding-and-the-tta-approach-in-terms-of-image-size-and-epoch-number">how to scale up on the model using padding and the tta approach in terms of image size and epoch number</a></li>
  <li><a href="#how-to-check-the-performance-of-the-scaled-up-model-using-validation-set" id="toc-how-to-check-the-performance-of-the-scaled-up-model-using-validation-set" class="nav-link" data-scroll-target="#how-to-check-the-performance-of-the-scaled-up-model-using-validation-set">how to check the performance of the scaled up model using validation set</a></li>
  </ul></li>
  <li><a href="#submission" id="toc-submission" class="nav-link" data-scroll-target="#submission">Submission</a>
  <ul class="collapse">
  <li><a href="#how-to-use-tta-to-predict-instead-of-the-usual-get_preds-to-get-predictions-on-the-test-set" id="toc-how-to-use-tta-to-predict-instead-of-the-usual-get_preds-to-get-predictions-on-the-test-set" class="nav-link" data-scroll-target="#how-to-use-tta-to-predict-instead-of-the-usual-get_preds-to-get-predictions-on-the-test-set">how to use TTA to predict instead of the usual <code>get_preds</code> to get predictions on the test set</a></li>
  <li><a href="#how-to-get-the-index-of-the-predictions" id="toc-how-to-get-the-index-of-the-predictions" class="nav-link" data-scroll-target="#how-to-get-the-index-of-the-predictions">how to get the index of the predictions</a></li>
  <li><a href="#how-to-replace-index-with-vocab-or-classes" id="toc-how-to-replace-index-with-vocab-or-classes" class="nav-link" data-scroll-target="#how-to-replace-index-with-vocab-or-classes">how to replace index with vocab or classes</a></li>
  <li><a href="#how-to-submit-prediction-csv-to-kaggle-with-comment-using-fastkaggle-api" id="toc-how-to-submit-prediction-csv-to-kaggle-with-comment-using-fastkaggle-api" class="nav-link" data-scroll-target="#how-to-submit-prediction-csv-to-kaggle-with-comment-using-fastkaggle-api">how to submit prediction csv to kaggle with comment using fastkaggle api</a></li>
  <li><a href="#how-to-push-local-notebook-to-kaggle-online" id="toc-how-to-push-local-notebook-to-kaggle-online" class="nav-link" data-scroll-target="#how-to-push-local-notebook-to-kaggle-online">how to push local notebook to Kaggle online</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/EmbraceLife/fastdebug/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">0009_fastai_small_models_road_to_the_top_part_2</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install fastkaggle if not available</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="im">import</span> fastkaggle</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> ModuleNotFoundError:</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q fastkaggle</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastkaggle <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</code></pre>
</div>
</div>
<p>This is part 2 of the <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">Road to the Top</a> series, in which I show the process I used to tackle the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor</a> competition, leading to four 1st place submissions. If you haven’t already, first check out <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">part 1</a>.</p>
<section id="going-faster" class="level2">
<h2 class="anchored" data-anchor-id="going-faster">Going faster</h2>
<p>First we’ll repeat the steps we used last time to access the data and ensure all the latest libraries are installed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>comp <span class="op">=</span> <span class="st">'paddy-disease-classification'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> setup_comp(comp, install<span class="op">=</span><span class="st">'"fastcore&gt;=1.4.5" "fastai&gt;=2.7.1" "timm&gt;=0.6.2.dev0"'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
tensorflow-io 0.21.0 requires tensorflow-io-gcs-filesystem==0.21.0, which is not installed.
tensorflow 2.6.4 requires absl-py~=0.10, but you have absl-py 1.0.0 which is incompatible.
tensorflow 2.6.4 requires numpy~=1.19.2, but you have numpy 1.21.6 which is incompatible.
tensorflow 2.6.4 requires six~=1.15.0, but you have six 1.16.0 which is incompatible.
tensorflow 2.6.4 requires wrapt~=1.12.1, but you have wrapt 1.14.1 which is incompatible.
tensorflow-transform 1.8.0 requires tensorflow!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,!=2.5.*,!=2.6.*,!=2.7.*,&lt;2.9,&gt;=1.15.5, but you have tensorflow 2.6.4 which is incompatible.
tensorflow-serving-api 2.8.0 requires tensorflow&lt;3,&gt;=2.8.0, but you have tensorflow 2.6.4 which is incompatible.
rich 12.4.4 requires typing-extensions&lt;5.0,&gt;=4.0.0; python_version &lt; "3.9", but you have typing-extensions 3.10.0.2 which is incompatible.
pytorch-lightning 1.6.3 requires typing-extensions&gt;=4.0.0, but you have typing-extensions 3.10.0.2 which is incompatible.
pytools 2022.1.9 requires typing-extensions&gt;=4.0; python_version &lt; "3.11", but you have typing-extensions 3.10.0.2 which is incompatible.
flax 0.5.0 requires typing-extensions&gt;=4.1.1, but you have typing-extensions 3.10.0.2 which is incompatible.
flake8 4.0.1 requires importlib-metadata&lt;4.3; python_version &lt; "3.8", but you have importlib-metadata 4.11.4 which is incompatible.
apache-beam 2.38.0 requires dill&lt;0.3.2,&gt;=0.3.1.1, but you have dill 0.3.5.1 which is incompatible.
apache-beam 2.38.0 requires httplib2&lt;0.20.0,&gt;=0.8, but you have httplib2 0.20.4 which is incompatible.
aioitertools 0.10.0 requires typing_extensions&gt;=4.0; python_version &lt; "3.10", but you have typing-extensions 3.10.0.2 which is incompatible.
aiobotocore 2.3.2 requires botocore&lt;1.24.22,&gt;=1.24.21, but you have botocore 1.26.7 which is incompatible.</code></pre>
</div>
</div>
<section id="why-kaggle-gpu-is-much-slower-for-training-and-how-does-fastai-to-fix-it-with-resize_images" class="level3">
<h3 class="anchored" data-anchor-id="why-kaggle-gpu-is-much-slower-for-training-and-how-does-fastai-to-fix-it-with-resize_images">why kaggle gpu is much slower for training and how does fastai to fix it with <code>resize_images</code></h3>
<p>A big issue I noticed last time was that originally I created the notebook on my home PC, and each epoch of the resnet we created took under 20 seconds to run. But on Kaggle they took over 3 minutes each! Whilst Kaggle’s GPUs are less powerful than what I’ve got at home, that doesn’t come close to explaining this vast difference in speed.</p>
<p>I noticed when Kaggle was running that the “GPU” indicator in the top right was nearly empty, and the “CPU” one was always full. This strongly suggests that the problem was that Kaggle’s notebook was CPU bound by decoding and resizing the images. This is a common problem on machines with poor CPU performance – and indeed Kaggle only provides 2 virtual CPUs at the time of writing.</p>
<p>We really need to fix this, since we need to be able to iterate much more quickly. What we can do is to simply resize all the images to half their height and width – which reduces their number of pixels 4x. This should mean an around 4x increase in performance for training small models.</p>
<p>Luckily, fastai has a function which does exactly this, whilst maintaining the folder structure of the data: <code>resize_images</code>.</p>
</section>
<section id="how-to-create-a-new-folder-with-path" class="level3">
<h3 class="anchored" data-anchor-id="how-to-create-a-new-folder-with-path">how to create a new folder with <code>Path</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> Path(<span class="st">'sml'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-resize-all-images-including-those-in-subfolders-of-train_images-folder-and-save-them-into-a-new-destination-folder-max_size-256-does-shrink-the-total-size-by-4-but-question-how-jeremy-pick-256-not-250" class="level3">
<h3 class="anchored" data-anchor-id="how-to-resize-all-images-including-those-in-subfolders-of-train_images-folder-and-save-them-into-a-new-destination-folder-max_size-256-does-shrink-the-total-size-by-4-but-question-how-jeremy-pick-256-not-250">how to resize all images (including those in subfolders) of <code>train_images</code> folder and save them into a new destination folder; max_size = 256 does shrink the total size by 4+, but question: how Jeremy pick 256 not 250;</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>resize_images(path<span class="op">/</span><span class="st">'train_images'</span>, dest<span class="op">=</span>trn_path, max_size<span class="op">=</span><span class="dv">256</span>, recurse<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-create-an-image-dataloaders-using-the-resized-image-folder-and-specify-the-resize-for-each-image-item-how-to-display-just-3-images-in-a-batch" class="level3">
<h3 class="anchored" data-anchor-id="how-to-create-an-image-dataloaders-using-the-resized-image-folder-and-specify-the-resize-for-each-image-item-how-to-display-just-3-images-in-a-batch">how to create an image dataloaders using the resized image folder and specify the resize for each image item; how to display just 3 images in a batch</h3>
<p>This will give us 192x256px images. Let’s take a look:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize((<span class="dv">256</span>,<span class="dv">192</span>)))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="0009_fastai_small_models_road_to_the_top_part_2_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="how-to-wrap-dataloaders-creation-model-creation-fine-tuning-together-in-a-func-train-and-return-the-trained-model-how-use-model-architecture-item-transforms-and-batch-transforms-and-num-of-epochs-as-the-params-of-the-train-function" class="level3">
<h3 class="anchored" data-anchor-id="how-to-wrap-dataloaders-creation-model-creation-fine-tuning-together-in-a-func-train-and-return-the-trained-model-how-use-model-architecture-item-transforms-and-batch-transforms-and-num-of-epochs-as-the-params-of-the-train-function">how to wrap dataloaders creation, model creation, fine tuning together in a func <code>train</code> and return the trained model; how use model architecture, item transforms, and batch transforms, and num of epochs as the params of the <code>train</code> function;</h3>
<p>In this notebook, we’ll be experimenting with a few different architectures and image processing approaches (item and batch transforms). In order to make this easier, we’ll put our modeling steps together into a little function which we can pass the architecture, item transforms, and batch transforms to:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(arch, item, batch, epochs<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, seed<span class="op">=</span><span class="dv">42</span>, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>item, batch_tfms<span class="op">=</span>batch)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate).to_fp16()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    learn.fine_tune(epochs, <span class="fl">0.01</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> learn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our <code>item_tfms</code> already resize our images to small sizes, so this shouldn’t impact the accuracy of our models much, if at all. Let’s re-run our resnet26d to test.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> train(<span class="st">'resnet26d'</span>, item<span class="op">=</span>Resize(<span class="dv">192</span>),</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>              batch<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://github.com/rwightman/pytorch-image-models/releases/download/v0.1-weights/resnet26d-69e92c46.pth" to /root/.cache/torch/hub/checkpoints/resnet26d-69e92c46.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.875997</td>
      <td>1.478083</td>
      <td>0.445459</td>
      <td>00:36</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.268640</td>
      <td>1.031712</td>
      <td>0.343585</td>
      <td>00:33</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.989115</td>
      <td>0.701631</td>
      <td>0.223931</td>
      <td>00:33</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.708181</td>
      <td>0.527319</td>
      <td>0.161941</td>
      <td>00:33</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.522309</td>
      <td>0.405053</td>
      <td>0.127343</td>
      <td>00:33</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.428306</td>
      <td>0.388762</td>
      <td>0.121576</td>
      <td>00:33</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>That’s a big improvement in speed, and the accuracy looks fine.</p>
</section>
</section>
<section id="a-convnext-model" class="level2">
<h2 class="anchored" data-anchor-id="a-convnext-model">A ConvNeXt model</h2>
<section id="how-to-tell-whether-a-larger-pretrained-model-would-affect-our-training-speed-by-reading-gpu-and-cpu-usage-bar-why-to-pick-convnext_small-for-our-second-model" class="level3">
<h3 class="anchored" data-anchor-id="how-to-tell-whether-a-larger-pretrained-model-would-affect-our-training-speed-by-reading-gpu-and-cpu-usage-bar-why-to-pick-convnext_small-for-our-second-model">How to tell whether a larger pretrained model would affect our training speed by reading GPU and CPU usage bar? why to pick convnext_small for our second model;</h3>
<p>I noticed that the GPU usage bar in Kaggle was still nearly empty, so we’re still CPU bound. That means we should be able to use a more capable model with little if any speed impact. Let’s look again at the options in <a href="https://www.kaggle.com/code/jhoward/the-best-vision-models-for-fine-tuning">The best vision models for fine-tuning</a>. <code>convnext_small</code> tops the performance/accuracy tradeoff score there, so let’s give it a go!</p>
</section>
<section id="how-to-load-and-use-a-new-pretrained-model-in-fastai" class="level3">
<h3 class="anchored" data-anchor-id="how-to-load-and-use-a-new-pretrained-model-in-fastai">how to load and use a new pretrained model in fastai</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'convnext_small_in22k'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> train(arch, item<span class="op">=</span>Resize(<span class="dv">192</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>              batch<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_small_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_small_22k_224.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.371264</td>
      <td>0.853445</td>
      <td>0.270062</td>
      <td>00:42</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.716509</td>
      <td>0.541614</td>
      <td>0.186449</td>
      <td>00:54</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.539565</td>
      <td>0.378337</td>
      <td>0.117251</td>
      <td>00:54</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.362223</td>
      <td>0.235239</td>
      <td>0.073522</td>
      <td>00:53</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.208453</td>
      <td>0.179712</td>
      <td>0.058626</td>
      <td>00:54</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.142692</td>
      <td>0.157421</td>
      <td>0.045651</td>
      <td>00:53</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>Wow our error rate has halved! That’s a great result. And, as expected, the speed hasn’t gone up much at all. This seems like a great model for iterating on.</p>
</section>
</section>
<section id="preprocessing-experiments" class="level2">
<h2 class="anchored" data-anchor-id="preprocessing-experiments">Preprocessing experiments</h2>
<section id="question-why-trying-different-ways-of-cutting-images-could-possibly-improve-model-performance-what-are-the-proper-options-for-cutting-images-or-preparing-images" class="level3">
<h3 class="anchored" data-anchor-id="question-why-trying-different-ways-of-cutting-images-could-possibly-improve-model-performance-what-are-the-proper-options-for-cutting-images-or-preparing-images">question: why trying different ways of cutting images could possibly improve model performance; what are the proper options for cutting images or preparing images</h3>
<p>So, what shall we try first? One thing which can make a difference is whether we “squish” a rectangular image into a square shape by changing it’s aspect ratio, or randomly crop out a square from it, or whether we add black padding to the edges to make it a square. In the previous version we “squished”. Let’s try “crop” instead, which is fastai’s default:</p>
</section>
<section id="how-to-try-cutting-image-with-crop-instead-of-squish" class="level3">
<h3 class="anchored" data-anchor-id="how-to-try-cutting-image-with-crop-instead-of-squish">how to try cutting image with <code>crop</code> instead of <code>squish</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> train(arch, item<span class="op">=</span>Resize(<span class="dv">192</span>),</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>              batch<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.380402</td>
      <td>0.855188</td>
      <td>0.283518</td>
      <td>00:40</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.758646</td>
      <td>0.532799</td>
      <td>0.172513</td>
      <td>00:51</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.587157</td>
      <td>0.407430</td>
      <td>0.133590</td>
      <td>00:52</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.390106</td>
      <td>0.260073</td>
      <td>0.082653</td>
      <td>00:52</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.245907</td>
      <td>0.188568</td>
      <td>0.061028</td>
      <td>00:52</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.185185</td>
      <td>0.160873</td>
      <td>0.049015</td>
      <td>00:52</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
<section id="what-is-transform-image-with-padding-and-how-does-it-differ-from-squish-and-crop" class="level3">
<h3 class="anchored" data-anchor-id="what-is-transform-image-with-padding-and-how-does-it-differ-from-squish-and-crop">what is transform image with padding and how does it differ from squish and crop</h3>
<p>That doesn’t seem to have made much difference…</p>
<p>We can also try padding, which keeps all the original image without transforming it – here’s what that looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">192</span>, method<span class="op">=</span>ResizeMethod.Pad, pad_mode<span class="op">=</span>PadMode.Zeros))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="0009_fastai_small_models_road_to_the_top_part_2_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="question-how-resize256-192-and-size171-128-are-determined" class="level3">
<h3 class="anchored" data-anchor-id="question-how-resize256-192-and-size171-128-are-determined">question: how <code>resize(256, 192)</code> and <code>size(171, 128)</code> are determined</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> train(arch, item<span class="op">=</span>Resize((<span class="dv">256</span>,<span class="dv">192</span>), method<span class="op">=</span>ResizeMethod.Pad, pad_mode<span class="op">=</span>PadMode.Zeros),</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>      batch<span class="op">=</span>aug_transforms(size<span class="op">=</span>(<span class="dv">171</span>,<span class="dv">128</span>), min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.349685</td>
      <td>0.873837</td>
      <td>0.283998</td>
      <td>00:44</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.727163</td>
      <td>0.486494</td>
      <td>0.155214</td>
      <td>01:01</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.576610</td>
      <td>0.401801</td>
      <td>0.127823</td>
      <td>01:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.369458</td>
      <td>0.265897</td>
      <td>0.083614</td>
      <td>01:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.214277</td>
      <td>0.185793</td>
      <td>0.056704</td>
      <td>01:01</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.157982</td>
      <td>0.162269</td>
      <td>0.045171</td>
      <td>01:00</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>That’s looking like a pretty good improvement.</p>
</section>
</section>
<section id="test-time-augmentation" class="level2">
<h2 class="anchored" data-anchor-id="test-time-augmentation">Test time augmentation</h2>
<section id="how-does-test-time-augmentation-tta-work-question-what-is-the-rationale-behind-tta" class="level3">
<h3 class="anchored" data-anchor-id="how-does-test-time-augmentation-tta-work-question-what-is-the-rationale-behind-tta">how does test time augmentation TTA work; question: what is the rationale behind TTA</h3>
<p>To make the predictions even better, we can try <a href="https://nbviewer.org/github/fastai/fastbook/blob/master/07_sizing_and_tta.ipynb#Test-Time-Augmentation">test time augmentation</a> (TTA), which <a href="https://www.amazon.com/Deep-Learning-Coders-fastai-PyTorch/dp/1492045527">our book</a> defines as:</p>
<blockquote class="blockquote">
<p><em>During inference or validation, creating multiple versions of each image, using data augmentation, and then taking the average or maximum of the predictions for each augmented version of the image.</em></p>
</blockquote>
<p>Before trying that out, we’ll first see how to check the predictions and error rate of our model without TTA:</p>
</section>
<section id="how-to-check-the-performance-of-our-model-on-validation-set" class="level3">
<h3 class="anchored" data-anchor-id="how-to-check-the-performance-of-our-model-on-validation-set">how to check the performance of our model on validation set</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> learn.dls.valid</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>preds,targs <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>error_rate(preds, targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>TensorBase(0.0452)</code></pre>
</div>
</div>
</section>
<section id="how-to-display-the-transformations-which-have-been-done-to-a-single-image-in-the-training-set" class="level3">
<h3 class="anchored" data-anchor-id="how-to-display-the-transformations-which-have-been-done-to-a-single-image-in-the-training-set">how to display the transformations which have been done to a single image in the training set</h3>
<p>That’s the same error rate we saw at the end of training, above, so we know that we’re doing that correctly.</p>
<p>Here’s what our data augmentation is doing – if you look carefully, you can see that each image is a bit lighter or darker, sometimes flipped, zoomed, rotated, warped, and/or zoomed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>learn.dls.train.show_batch(max_n<span class="op">=</span><span class="dv">6</span>, unique<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="0009_fastai_small_models_road_to_the_top_part_2_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="how-to-do-tta-on-validation-set" class="level3">
<h3 class="anchored" data-anchor-id="how-to-do-tta-on-validation-set">how to do TTA on validation set</h3>
<p>If we call <code>tta()</code> then we’ll get the average of predictions made for multiple different augmented versions of each image, along with the unaugmented original:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>tta_preds,_ <span class="op">=</span> learn.tta(dl<span class="op">=</span>valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="5" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
</section>
<section id="how-to-calc-the-error-rate-of-the-tta_preds" class="level3">
<h3 class="anchored" data-anchor-id="how-to-calc-the-error-rate-of-the-tta_preds">how to calc the error rate of the tta_preds</h3>
<p>Let’s check the error rate of this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>error_rate(tta_preds, targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>TensorBase(0.0485)</code></pre>
</div>
</div>
<p>That’s a huge improvement! We’ll definitely want to use this for any submission we make!</p>
</section>
</section>
<section id="scaling-up" class="level2">
<h2 class="anchored" data-anchor-id="scaling-up">Scaling up</h2>
<section id="how-to-scale-up-on-the-model-using-padding-and-the-tta-approach-in-terms-of-image-size-and-epoch-number" class="level3">
<h3 class="anchored" data-anchor-id="how-to-scale-up-on-the-model-using-padding-and-the-tta-approach-in-terms-of-image-size-and-epoch-number">how to scale up on the model using padding and the tta approach in terms of image size and epoch number</h3>
<p>Now that we’ve got a pretty good model and preprocessing approach, let’s scale it up to larger images and more epochs. We’ll switch back our path to the original un-resized images, and use 12 epochs using our best settings so far, with larger final augmented images:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> path<span class="op">/</span><span class="st">'train_images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> train(arch, epochs<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>              item<span class="op">=</span>Resize((<span class="dv">480</span>, <span class="dv">360</span>), method<span class="op">=</span>ResizeMethod.Pad, pad_mode<span class="op">=</span>PadMode.Zeros),</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>              batch<span class="op">=</span>aug_transforms(size<span class="op">=</span>(<span class="dv">256</span>,<span class="dv">192</span>), min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.240577</td>
      <td>0.803256</td>
      <td>0.260932</td>
      <td>02:19</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.622355</td>
      <td>0.316984</td>
      <td>0.097069</td>
      <td>02:35</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.453550</td>
      <td>0.296619</td>
      <td>0.094666</td>
      <td>02:34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.389912</td>
      <td>0.296899</td>
      <td>0.087458</td>
      <td>02:35</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.344765</td>
      <td>0.258925</td>
      <td>0.076406</td>
      <td>02:33</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.264739</td>
      <td>0.207181</td>
      <td>0.058626</td>
      <td>02:34</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.193956</td>
      <td>0.128093</td>
      <td>0.035560</td>
      <td>02:34</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.149894</td>
      <td>0.137023</td>
      <td>0.037482</td>
      <td>02:33</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.096056</td>
      <td>0.123581</td>
      <td>0.033157</td>
      <td>02:35</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.079198</td>
      <td>0.102848</td>
      <td>0.028832</td>
      <td>02:36</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.055733</td>
      <td>0.095993</td>
      <td>0.024988</td>
      <td>02:35</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.041112</td>
      <td>0.090146</td>
      <td>0.022105</td>
      <td>02:33</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.038906</td>
      <td>0.090561</td>
      <td>0.022105</td>
      <td>02:35</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
<section id="how-to-check-the-performance-of-the-scaled-up-model-using-validation-set" class="level3">
<h3 class="anchored" data-anchor-id="how-to-check-the-performance-of-the-scaled-up-model-using-validation-set">how to check the performance of the scaled up model using validation set</h3>
<p>This is around twice as accurate as our previous best model - let’s see how it performs with TTA too:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tta_preds,targs <span class="op">=</span> learn.tta(dl<span class="op">=</span>learn.dls.valid)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>error_rate(tta_preds, targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>TensorBase(0.0197)</code></pre>
</div>
</div>
<p>Once again, we get a big boost from TTA. This is one of the most under-appreciated deep learning tricks, in my opinion! (I’m not sure there’s any other frameworks that make it quite so easy, so perhaps that’s part of the reason why…)</p>
</section>
</section>
<section id="submission" class="level2">
<h2 class="anchored" data-anchor-id="submission">Submission</h2>
<section id="how-to-use-tta-to-predict-instead-of-the-usual-get_preds-to-get-predictions-on-the-test-set" class="level3">
<h3 class="anchored" data-anchor-id="how-to-use-tta-to-predict-instead-of-the-usual-get_preds-to-get-predictions-on-the-test-set">how to use TTA to predict instead of the usual <code>get_preds</code> to get predictions on the test set</h3>
<p>We’re now ready to get our Kaggle submission sorted. First, we’ll grab the test set like we did in the last notebook:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>).<span class="bu">sorted</span>()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>tst_dl <span class="op">=</span> learn.dls.test_dl(tst_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, do TTA on that test set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>preds,_ <span class="op">=</span> learn.tta(dl<span class="op">=</span>tst_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
</section>
<section id="how-to-get-the-index-of-the-predictions" class="level3">
<h3 class="anchored" data-anchor-id="how-to-get-the-index-of-the-predictions">how to get the index of the predictions</h3>
<p>We need to indices of the largest probability prediction in each row, since that’s the index of the predicted disease. <code>argmax</code> in PyTorch gives us exactly that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> preds.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-replace-index-with-vocab-or-classes" class="level3">
<h3 class="anchored" data-anchor-id="how-to-replace-index-with-vocab-or-classes">how to replace index with vocab or classes</h3>
<p>Now we need to look up those indices in the <code>vocab</code>. Last time we did that using pandas, although since then I realised there’s an even easier way!:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> np.array(learn.dls.vocab)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> pd.Series(vocab[idxs], name<span class="op">=</span><span class="st">"idxs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>ss[<span class="st">'label'</span>] <span class="op">=</span> results</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
</section>
<section id="how-to-submit-prediction-csv-to-kaggle-with-comment-using-fastkaggle-api" class="level3">
<h3 class="anchored" data-anchor-id="how-to-submit-prediction-csv-to-kaggle-with-comment-using-fastkaggle-api">how to submit prediction csv to kaggle with comment using fastkaggle api</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> iskaggle:</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> kaggle <span class="im">import</span> api</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    api.competition_submit_cli(<span class="st">'subm.csv'</span>, <span class="st">'convnext small 256x192 12 epochs tta'</span>, comp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-push-local-notebook-to-kaggle-online" class="level3">
<h3 class="anchored" data-anchor-id="how-to-push-local-notebook-to-kaggle-online">how to push local notebook to Kaggle online</h3>
<p>This gets a score of 0.9827, which is well within the top 25% of the competition – that’s a big improvement, and we’re still using a single small model!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is what I use to push my notebook from my home PC to Kaggle</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> iskaggle:</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    push_notebook(<span class="st">'jhoward'</span>, <span class="st">'small-models-road-to-the-top-part-2'</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                  title<span class="op">=</span><span class="st">'Small models: Road to the Top, Part 2'</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">file</span><span class="op">=</span><span class="st">'small-models-road-to-the-top-part-2.ipynb'</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                  competition<span class="op">=</span>comp, private<span class="op">=</span><span class="va">True</span>, gpu<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We’ve made a big step today, despite just using a single model that trains in under 20 minutes even on Kaggle’s rather under-powered machines. Next time, we’ll try scaling up to some bigger models and doing some ensembling.</p>
<p>If you found this notebook useful, please remember to click the little up-arrow at the top to upvote it, since I like to know when people have found my work useful, and it helps others find it too. And if you have any questions or comments, please pop them below – I read every comment I receive!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>