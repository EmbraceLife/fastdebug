<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>fastdebug - 0021_fastai_pt2_2019_fully_connected</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="fastdebug - 0021_fastai_pt2_2019_fully_connected">
<meta property="og:site-name" content="fastdebug">
<meta name="twitter:title" content="fastdebug - 0021_fastai_pt2_2019_fully_connected">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">fastdebug</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">0021_fastai_pt2_2019_fully_connected</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Learning fastai with joy</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Interesting_fastai</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Interesting_fastai/the_origin_of_apl .html" class="sidebar-item-text sidebar-link">0001_The_origin_of_APL</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Interesting_fastai/Interesting_things_fastai.html" class="sidebar-item-text sidebar-link">Interesting_things_fastai.html</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">demos</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/intro_fastdebug.html" class="sidebar-item-text sidebar-link">Introducing fastdebug</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/tour.html" class="sidebar-item-text sidebar-link">0000_tour</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore_meta_delegates.html" class="sidebar-item-text sidebar-link">0001_Fastcore.meta.delegates</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/signature_from_callable.html" class="sidebar-item-text sidebar-link">0002_signature_from_callable</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/explore_document_fixsigmeta_prepostinitmeta_autoinit.html" class="sidebar-item-text sidebar-link">03_FixSigMeta_PrePostInitMeta_AutoInit</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta._rm_self.html" class="sidebar-item-text sidebar-link">04_rm_self</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta.test_sig.html" class="sidebar-item-text sidebar-link">05_test_sig</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta.newchkmeta.html" class="sidebar-item-text sidebar-link">06_NewChkMeta</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore.meta.bypassnewmeta.html" class="sidebar-item-text sidebar-link">07_BypassNewMeta</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/use_kwargs_dict.html" class="sidebar-item-text sidebar-link">08_use_kwargs_dict</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/funcs_kwargs.html" class="sidebar-item-text sidebar-link">09_method_funcs_kwargs</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore_meta_summary.html" class="sidebar-item-text sidebar-link">0010_fastcore_meta_summary</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastdb.html" class="sidebar-item-text sidebar-link">0011_Fastdb</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos/fastcore_foundation_l.html" class="sidebar-item-text sidebar-link">0012_fastcore_foundation_L</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">fastai_notebooks</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_is_it_a_bird.html" class="sidebar-item-text sidebar-link">0001_fastai_Is it a bird? Creating a model from your own data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_saving_a_basic_fastai_model.html" class="sidebar-item-text sidebar-link">0002_fastai_saving_a_basic_fastai_model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_which_image_model_best.html" class="sidebar-item-text sidebar-link">0003_fastai_which_image_model_best</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_how_neuralnet_work.html" class="sidebar-item-text sidebar-link">0004_fastai_how_neuralnet_work</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_linear_neuralnet_scratch.html" class="sidebar-item-text sidebar-link">0005_fastai_linear_neuralnet_scratch</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_why_should_use_framework.html" class="sidebar-item-text sidebar-link">0006_fastai_why_should_use_framework</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_how_random_forests_really_work.html" class="sidebar-item-text sidebar-link">0007_fastai_how_random_forests_really_work</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_first_steps_road_to_top_part_1.html" class="sidebar-item-text sidebar-link">0008_fastai_first_steps_road_to_top_part_1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_small_models_road_to_the_top_part_2.html" class="sidebar-item-text sidebar-link">0009_fastai_small_models_road_to_the_top_part_2</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_scaling_up_road_to_top_part_3.html" class="sidebar-item-text sidebar-link">0010_fastai_scaling_up_road_to_top_part_3</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_multi_target_road_to_top_part_4.html" class="sidebar-item-text sidebar-link">0011_fastai_multi_target_road_to_top_part_4</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_using_nbdev_export_in_kaggle_notebook.html" class="sidebar-item-text sidebar-link">0012_fastai_using_nbdev_export_in_kaggle_notebook</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/best_vision_models_for_fine_tuning.html" class="sidebar-item-text sidebar-link">0013_best_vision_models_for_fine_tuning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/iterate_like_grandmaster.html" class="sidebar-item-text sidebar-link">0014_iterate_like_grandmaster</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/getting_started_with_nlp_for_absolute_beginner.html" class="sidebar-item-text sidebar-link">0015_getting_started_with_nlp_for_absolute_beginner</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/collaborative_filtering_deep_dive.html" class="sidebar-item-text sidebar-link">0016_collaborative_filtering_deep_dive</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptmatmul.html" class="sidebar-item-text sidebar-link">0017_fastai_pt2_2019_matmul</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptexports.html" class="sidebar-item-text sidebar-link">0018_fastai_pt2_2019_exports</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptlectureintro.html" class="sidebar-item-text sidebar-link">0019_fastai_pt2_2019_lecture1_intro</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptsource_explained.html" class="sidebar-item-text sidebar-link">0020_fastai_pt2_2019_source_explained</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptfully_connected.html" class="sidebar-item-text sidebar-link active">0021_fastai_pt2_2019_fully_connected</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_notebooks/fastai_ptwhy_sqrt5.html" class="sidebar-item-text sidebar-link">0022_fastai_pt2_2019_why_sqrt5</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">questions</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../questions/question_anno_dict.html" class="sidebar-item-text sidebar-link">00_quesolved_anno_dict</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-forward-and-backward-passes" id="toc-the-forward-and-backward-passes" class="nav-link active" data-scroll-target="#the-forward-and-backward-passes">The forward and backward passes</a>
  <ul class="collapse">
  <li><a href="#get_data" id="toc-get_data" class="nav-link" data-scroll-target="#get_data">get_data</a></li>
  <li><a href="#normalizex-m-s" id="toc-normalizex-m-s" class="nav-link" data-scroll-target="#normalizex-m-s">normalize(x, m, s)</a></li>
  <li><a href="#test_near_zero-and-assert" id="toc-test_near_zero-and-assert" class="nav-link" data-scroll-target="#test_near_zero-and-assert">test_near_zero and assert</a></li>
  <li><a href="#getting-dimensions-of-weights-of-different-layers" id="toc-getting-dimensions-of-weights-of-different-layers" class="nav-link" data-scroll-target="#getting-dimensions-of-weights-of-different-layers">getting dimensions of weights of different layers</a></li>
  </ul></li>
  <li><a href="#foundations-version" id="toc-foundations-version" class="nav-link" data-scroll-target="#foundations-version">Foundations version</a></li>
  <li><a href="#basic-architecture" id="toc-basic-architecture" class="nav-link" data-scroll-target="#basic-architecture">Basic architecture</a>
  <ul class="collapse">
  <li><a href="#initialize-weightsbiases-using-xavier-init-to-ensure-the-first-layers-activation-with-mean-0-and-std-1" id="toc-initialize-weightsbiases-using-xavier-init-to-ensure-the-first-layers-activation-with-mean-0-and-std-1" class="nav-link" data-scroll-target="#initialize-weightsbiases-using-xavier-init-to-ensure-the-first-layers-activation-with-mean-0-and-std-1">initialize weights/biases using Xavier init to ensure the first layer’s activation with mean 0 and std 1</a></li>
  <li><a href="#writing-a-linear-layer-with-relu-from-scratch" id="toc-writing-a-linear-layer-with-relu-from-scratch" class="nav-link" data-scroll-target="#writing-a-linear-layer-with-relu-from-scratch">writing a linear layer with relu from scratch</a></li>
  <li><a href="#but-relu-does-not-return-the-activation-with-mean-0-and-std-1-actually-halved-the-std-and-the-gradients-for-updating-weights-will-be-gone-when-more-layers-or-more-relus-applied-and-jeremy-explained-why-it-is-so" id="toc-but-relu-does-not-return-the-activation-with-mean-0-and-std-1-actually-halved-the-std-and-the-gradients-for-updating-weights-will-be-gone-when-more-layers-or-more-relus-applied-and-jeremy-explained-why-it-is-so" class="nav-link" data-scroll-target="#but-relu-does-not-return-the-activation-with-mean-0-and-std-1-actually-halved-the-std-and-the-gradients-for-updating-weights-will-be-gone-when-more-layers-or-more-relus-applied-and-jeremy-explained-why-it-is-so">1:30:50 - but relu does not return the activation with mean 0 and std 1, (actually halved the std, and the gradients for updating weights will be gone when more layers or more ReLUs applied) and Jeremy explained why it is so</a></li>
  <li><a href="#jeremy-introduced-and-lead-us-reading-delving-deep-into-rectifiers-by-he-why-we-should-read-papers-from-competition-winners-than-other-papers-13243---jeremy-explained-rectifiers-in-the-paper-and-why-random-weightsbiases-wont-get-trained-well-using-hes-paper-and-xaviers-paper-xaviers-initialization-didnt-account-for-the-impact-of-relu-this-is-where-hes-paper-come-in-the-homework-is-to-read-this-section-2.2-of-the-hes-paper." id="toc-jeremy-introduced-and-lead-us-reading-delving-deep-into-rectifiers-by-he-why-we-should-read-papers-from-competition-winners-than-other-papers-13243---jeremy-explained-rectifiers-in-the-paper-and-why-random-weightsbiases-wont-get-trained-well-using-hes-paper-and-xaviers-paper-xaviers-initialization-didnt-account-for-the-impact-of-relu-this-is-where-hes-paper-come-in-the-homework-is-to-read-this-section-2.2-of-the-hes-paper." class="nav-link" data-scroll-target="#jeremy-introduced-and-lead-us-reading-delving-deep-into-rectifiers-by-he-why-we-should-read-papers-from-competition-winners-than-other-papers-13243---jeremy-explained-rectifiers-in-the-paper-and-why-random-weightsbiases-wont-get-trained-well-using-hes-paper-and-xaviers-paper-xaviers-initialization-didnt-account-for-the-impact-of-relu-this-is-where-hes-paper-come-in-the-homework-is-to-read-this-section-2.2-of-the-hes-paper.">1:31:47 - Jeremy introduced and lead us reading <strong>Delving Deep into Rectifiers</strong> by He; why we should read papers from competition winners than other papers; 1:32:43 - Jeremy explained Rectifiers in the paper and why random weights/biases won’t get trained well using He’s paper and Xavier’s paper (Xavier’s initialization didn’t account for the impact of ReLU, this is where He’s paper come in); the homework is to read this section (2.2) of the He’s paper.</a></li>
  <li><a href="#jeremy-provided-a-guidance-to-us-on-how-to-read-the-resnet-paper" id="toc-jeremy-provided-a-guidance-to-us-on-how-to-read-the-resnet-paper" class="nav-link" data-scroll-target="#jeremy-provided-a-guidance-to-us-on-how-to-read-the-resnet-paper">1:36:26 - Jeremy provided a guidance to us on how to read the Resnet paper</a></li>
  <li><a href="#how-to-use-pytorch-function-torch.nn.init.kaiming_normal_-to-do-he-init-and-how-to-dig-into-pytorch-source-code-to-figure-out-how-to-use-those-functions-correctly-like-why-fan_out-in-init.kaiming_normal_w1-modefan_out" id="toc-how-to-use-pytorch-function-torch.nn.init.kaiming_normal_-to-do-he-init-and-how-to-dig-into-pytorch-source-code-to-figure-out-how-to-use-those-functions-correctly-like-why-fan_out-in-init.kaiming_normal_w1-modefan_out" class="nav-link" data-scroll-target="#how-to-use-pytorch-function-torch.nn.init.kaiming_normal_-to-do-he-init-and-how-to-dig-into-pytorch-source-code-to-figure-out-how-to-use-those-functions-correctly-like-why-fan_out-in-init.kaiming_normal_w1-modefan_out">1:39:44 - how to use pytorch function <code>torch.nn.init.kaiming_normal_</code> to do He init and how to dig into pytorch source code to figure out how to use those functions correctly like why <code>fan_out</code> in <code>init.kaiming_normal_(w1, mode='fan_out')</code></a></li>
  <li><a href="#how-to-find-and-read-source-code-of-convolutional-layer-in-pytorch-and-why-it-is-a-good-idea-to-put-the-url-of-the-paper-you-are-implementing-in-the-source-code" id="toc-how-to-find-and-read-source-code-of-convolutional-layer-in-pytorch-and-why-it-is-a-good-idea-to-put-the-url-of-the-paper-you-are-implementing-in-the-source-code" class="nav-link" data-scroll-target="#how-to-find-and-read-source-code-of-convolutional-layer-in-pytorch-and-why-it-is-a-good-idea-to-put-the-url-of-the-paper-you-are-implementing-in-the-source-code">1:42:56 - how to find and read source code of convolutional layer in pytorch and why it is a good idea to put the url of the paper you are implementing in the source code</a></li>
  <li><a href="#jeremy-noticed-a-problem-of-the-he-initialization-on-the-value-of-mean-and-explained-why-so-then-he-tried-to-a-simple-but-natural-method-to-bring-the-mean-to-0-and-the-result-seems-very-good-and-ended-here-at-13944-14435---how-much-better-does-jeremys-tweaked-relu-work-for-getting-activation-mean-to-0-and-std-to-0.8-rather-than-previously-0.7" id="toc-jeremy-noticed-a-problem-of-the-he-initialization-on-the-value-of-mean-and-explained-why-so-then-he-tried-to-a-simple-but-natural-method-to-bring-the-mean-to-0-and-the-result-seems-very-good-and-ended-here-at-13944-14435---how-much-better-does-jeremys-tweaked-relu-work-for-getting-activation-mean-to-0-and-std-to-0.8-rather-than-previously-0.7" class="nav-link" data-scroll-target="#jeremy-noticed-a-problem-of-the-he-initialization-on-the-value-of-mean-and-explained-why-so-then-he-tried-to-a-simple-but-natural-method-to-bring-the-mean-to-0-and-the-result-seems-very-good-and-ended-here-at-13944-14435---how-much-better-does-jeremys-tweaked-relu-work-for-getting-activation-mean-to-0-and-std-to-0.8-rather-than-previously-0.7">1:38:55 - Jeremy noticed a problem of the He initialization on the value of mean and explained why so; then he tried to a simple but natural method to bring the mean to 0 and the result seems very good and ended here at 1:39:44 1:44:35 - how much better does Jeremy’s tweaked ReLU work for getting activation mean to 0 and std to 0.8 rather than previously 0.7</a></li>
  <li><a href="#how-to-build-our-model-model-using-the-functions-lin-relu-we-built-above-how-to-test-how-fast-it-is-to-run-and-how-to-verify-the-shape-of-the-model-output-to-be-correct" id="toc-how-to-build-our-model-model-using-the-functions-lin-relu-we-built-above-how-to-test-how-fast-it-is-to-run-and-how-to-verify-the-shape-of-the-model-output-to-be-correct" class="nav-link" data-scroll-target="#how-to-build-our-model-model-using-the-functions-lin-relu-we-built-above-how-to-test-how-fast-it-is-to-run-and-how-to-verify-the-shape-of-the-model-output-to-be-correct">1:45:28 - how to build our model <code>model</code> using the functions <code>lin</code>, <code>relu</code> we built above; how to test how fast it is to run; and how to verify the shape of the model output to be correct</a></li>
  </ul></li>
  <li><a href="#loss-function-mse" id="toc-loss-function-mse" class="nav-link" data-scroll-target="#loss-function-mse">Loss function: MSE</a>
  <ul class="collapse">
  <li><a href="#how-to-write-mean-squared-error-as-our-loss-function-we-never-use-it-but-only-use-mse-as-a-starting-point-for-our-loss-how-to-squeeze-a-tensor-with-shape-n-1-to-just-shape-n-using-output.squeeze-1" id="toc-how-to-write-mean-squared-error-as-our-loss-function-we-never-use-it-but-only-use-mse-as-a-starting-point-for-our-loss-how-to-squeeze-a-tensor-with-shape-n-1-to-just-shape-n-using-output.squeeze-1" class="nav-link" data-scroll-target="#how-to-write-mean-squared-error-as-our-loss-function-we-never-use-it-but-only-use-mse-as-a-starting-point-for-our-loss-how-to-squeeze-a-tensor-with-shape-n-1-to-just-shape-n-using-output.squeeze-1">1:46:15 - how to write mean squared error as our loss function (we never use it but only use mse as a starting point for our loss); how to squeeze a tensor with shape [n, 1] to just shape [n] using <code>output.squeeze(-1)</code></a></li>
  </ul></li>
  <li><a href="#gradients-and-backward-pass" id="toc-gradients-and-backward-pass" class="nav-link" data-scroll-target="#gradients-and-backward-pass">Gradients and backward pass</a>
  <ul class="collapse">
  <li><a href="#jeremy-has-given-us-all-the-matrix-calculus-we-need-for-deep-learning-for-total-beginners-14912---how-to-understand-and-do-the-chain-rule-in-terms-of-getting-gradients-with-respect-to-params-of-our-model-and-how-to-understand-derivative-in-plain-language-15256---how-to-calculuate-the-derivate-or-gradient-with-respect-to-the-output-of-previous-layer-or-funcs-mse-lin-relu" id="toc-jeremy-has-given-us-all-the-matrix-calculus-we-need-for-deep-learning-for-total-beginners-14912---how-to-understand-and-do-the-chain-rule-in-terms-of-getting-gradients-with-respect-to-params-of-our-model-and-how-to-understand-derivative-in-plain-language-15256---how-to-calculuate-the-derivate-or-gradient-with-respect-to-the-output-of-previous-layer-or-funcs-mse-lin-relu" class="nav-link" data-scroll-target="#jeremy-has-given-us-all-the-matrix-calculus-we-need-for-deep-learning-for-total-beginners-14912---how-to-understand-and-do-the-chain-rule-in-terms-of-getting-gradients-with-respect-to-params-of-our-model-and-how-to-understand-derivative-in-plain-language-15256---how-to-calculuate-the-derivate-or-gradient-with-respect-to-the-output-of-previous-layer-or-funcs-mse-lin-relu">1:48:00 - Jeremy has given us all the matrix calculus we need for deep learning for total beginners; 1:49:12 - how to understand and do the chain rule in terms of getting gradients with respect to params of our model and how to understand derivative in plain language; 1:52:56 - how to calculuate the derivate or gradient with respect to the output of previous layer or funcs ( <code>mse</code>, <code>lin</code>, <code>relu</code> )</a></li>
  <li><a href="#how-to-put-forward-pass-and-backward-pass-into-one-function-foward_and_backward-and-backward-pass-is-the-chain-rule-people-who-say-no-are-liars-and-saving-the-gradients-as-well" id="toc-how-to-put-forward-pass-and-backward-pass-into-one-function-foward_and_backward-and-backward-pass-is-the-chain-rule-people-who-say-no-are-liars-and-saving-the-gradients-as-well" class="nav-link" data-scroll-target="#how-to-put-forward-pass-and-backward-pass-into-one-function-foward_and_backward-and-backward-pass-is-the-chain-rule-people-who-say-no-are-liars-and-saving-the-gradients-as-well">1:55:22 - how to put forward pass and backward pass into one function <code>foward_and_backward</code>; and backward pass is the chain rule (people who say No are liars) and saving the gradients as well;</a></li>
  <li><a href="#how-to-use-pytorchs-gradient-calculation-functions-to-test-whether-our-own-gradients-are-calculated-correctly" id="toc-how-to-use-pytorchs-gradient-calculation-functions-to-test-whether-our-own-gradients-are-calculated-correctly" class="nav-link" data-scroll-target="#how-to-use-pytorchs-gradient-calculation-functions-to-test-whether-our-own-gradients-are-calculated-correctly">1:56:41 - how to use pytorch’s gradient calculation functions to test whether our own gradients are calculated correctly;</a></li>
  </ul></li>
  <li><a href="#refactor-model" id="toc-refactor-model" class="nav-link" data-scroll-target="#refactor-model">Refactor model</a></li>
  <li><a href="#layers-as-classes" id="toc-layers-as-classes" class="nav-link" data-scroll-target="#layers-as-classes">Layers as classes</a>
  <ul class="collapse">
  <li><a href="#how-to-refactor-the-previous-funcs-into-classes-after-jeremy-has-done-the-refactory-work-it-becomes-almost-identical-to-pytorch-api" id="toc-how-to-refactor-the-previous-funcs-into-classes-after-jeremy-has-done-the-refactory-work-it-becomes-almost-identical-to-pytorch-api" class="nav-link" data-scroll-target="#how-to-refactor-the-previous-funcs-into-classes-after-jeremy-has-done-the-refactory-work-it-becomes-almost-identical-to-pytorch-api">1:58:16 - how to refactor the previous funcs into classes; After Jeremy has done the refactory work, it becomes almost identical to pytorch api</a></li>
  </ul></li>
  <li><a href="#module.forward" id="toc-module.forward" class="nav-link" data-scroll-target="#module.forward">Module.forward()</a>
  <ul class="collapse">
  <li><a href="#how-to-remove-duplicated-codes-by-adding-another-class-module-and-using-einsum-and-as-a-result-our-refactor-codes-become-identical-to-pytorch-api-this-step-truly-help-make-sense-pytorch-api" id="toc-how-to-remove-duplicated-codes-by-adding-another-class-module-and-using-einsum-and-as-a-result-our-refactor-codes-become-identical-to-pytorch-api-this-step-truly-help-make-sense-pytorch-api" class="nav-link" data-scroll-target="#how-to-remove-duplicated-codes-by-adding-another-class-module-and-using-einsum-and-as-a-result-our-refactor-codes-become-identical-to-pytorch-api-this-step-truly-help-make-sense-pytorch-api">2:02:36 - how to remove duplicated codes by adding another class Module and using <code>einsum</code>, and as a result, our refactor codes become identical to pytorch api; this step truly help make sense pytorch api</a></li>
  </ul></li>
  <li><a href="#without-einsum" id="toc-without-einsum" class="nav-link" data-scroll-target="#without-einsum">Without einsum</a>
  <ul class="collapse">
  <li><a href="#how-to-replace-einsum-with-pure-matrix-multiplication-with-and-as-a-result-our-own-code-from-scratch-is-as-fast-as-pytorch-20544-plan-for-the-next-lesson" id="toc-how-to-replace-einsum-with-pure-matrix-multiplication-with-and-as-a-result-our-own-code-from-scratch-is-as-fast-as-pytorch-20544-plan-for-the-next-lesson" class="nav-link" data-scroll-target="#how-to-replace-einsum-with-pure-matrix-multiplication-with-and-as-a-result-our-own-code-from-scratch-is-as-fast-as-pytorch-20544-plan-for-the-next-lesson">2:04:44 - how to replace <code>einsum</code> with pure matrix multiplication with <code>@</code>; and as a result, our own code from scratch is as fast as pytorch 2:05:44 plan for the next lesson</a></li>
  <li><a href="#nn.linear-and-nn.module" id="toc-nn.linear-and-nn.module" class="nav-link" data-scroll-target="#nn.linear-and-nn.module">nn.Linear and nn.Module</a></li>
  </ul></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/EmbraceLife/fastdebug/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">0021_fastai_pt2_2019_fully_connected</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="the-forward-and-backward-passes" class="level2">
<h2 class="anchored" data-anchor-id="the-forward-and-backward-passes">The forward and backward passes</h2>
<section id="get_data" class="level3">
<h3 class="anchored" data-anchor-id="get_data">get_data</h3>
<section id="how-to-download-and-prepare-the-mnist-dataset-and-wrap-the-process-into-a-function-called-get_data" class="level4">
<h4 class="anchored" data-anchor-id="how-to-download-and-prepare-the-mnist-dataset-and-wrap-the-process-into-a-function-called-get_data"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=4983">1:23:03</a> - how to download and prepare the mnist dataset and wrap the process into a function called <code>get_data</code>;</h4>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=4960">Jump_to lesson 8 video</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> exp.nb_01 <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_data():</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> datasets.download_data(MNIST_URL, ext<span class="op">=</span><span class="st">'.gz'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> gzip.<span class="bu">open</span>(path, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        ((x_train, y_train), (x_valid, y_valid), _) <span class="op">=</span> pickle.load(f, encoding<span class="op">=</span><span class="st">'latin-1'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">map</span>(tensor, (x_train,y_train,x_valid,y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>x_train,y_train,x_valid,y_valid <span class="op">=</span> get_data()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="normalizex-m-s" class="level3">
<h3 class="anchored" data-anchor-id="normalizex-m-s">normalize(x, m, s)</h3>
<section id="how-to-create-normalize-function-to-use-broadcast-to-normalize-the-xs-and-ys-what-does-normalization-to-xs-and-ys-mean-make-xs-and-ys-to-have-a-distribution-whose-mean-is-0-and-std-is-1-how-to-make-the-mean-and-std-of-xs-and-ys-to-be-0-and-1-using-the-formula-of-normalization-below-why-we-dont-use-validation-sets-mean-and-std-to-normalization-xs-and-ys-of-validation-set-but-use-those-of-training-set-make-sure-validation-set-and-training-set-share-the-same-scale-as-training-set-what-example-did-jeremy-give-to-explain-the-importance-of-using-training-sets-mean-and-std-for-normalization-of-validation-set" class="level4">
<h4 class="anchored" data-anchor-id="how-to-create-normalize-function-to-use-broadcast-to-normalize-the-xs-and-ys-what-does-normalization-to-xs-and-ys-mean-make-xs-and-ys-to-have-a-distribution-whose-mean-is-0-and-std-is-1-how-to-make-the-mean-and-std-of-xs-and-ys-to-be-0-and-1-using-the-formula-of-normalization-below-why-we-dont-use-validation-sets-mean-and-std-to-normalization-xs-and-ys-of-validation-set-but-use-those-of-training-set-make-sure-validation-set-and-training-set-share-the-same-scale-as-training-set-what-example-did-jeremy-give-to-explain-the-importance-of-using-training-sets-mean-and-std-for-normalization-of-validation-set"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5028">1:23:48</a> - how to create <a href="https://EmbraceLife.github.io/fastdebug/lib/groundup_get_data_ready.html#normalize"><code>normalize</code></a> function to use broadcast to normalize the Xs and Ys; what does normalization to Xs and Ys mean (make Xs and Ys to have a distribution whose mean is 0 and std is 1)? how to make the mean and std of Xs and Ys to be 0 and 1 (using the formula of normalization below) Why we don’t use validation set’s mean and std to normalization Xs and Ys of validation set but use those of training set? (make sure validation set and training set share the same scale as training set) What example did Jeremy give to explain the importance of using training set’s mean and std for normalization of validation set</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize(x, m, s): <span class="cf">return</span> (x<span class="op">-</span>m)<span class="op">/</span>s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>train_mean,train_std <span class="op">=</span> x_train.mean(),x_train.std()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>train_mean,train_std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> normalize(x_train, train_mean, train_std)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: Use training, not validation mean for validation set</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>x_valid <span class="op">=</span> normalize(x_valid, train_mean, train_std)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="test_near_zero-and-assert" class="level3">
<h3 class="anchored" data-anchor-id="test_near_zero-and-assert">test_near_zero and assert</h3>
<section id="how-to-check-the-mean-and-std-values-are-close-to-0-and-1-using-test_near_zero-using-assert" class="level4">
<h4 class="anchored" data-anchor-id="how-to-check-the-mean-and-std-values-are-close-to-0-and-1-using-test_near_zero-using-assert"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5092">1:24:52</a> - how to check the mean and std values are close to 0 and 1 using <code>test_near_zero</code> using <code>assert</code></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>train_mean,train_std <span class="op">=</span> x_train.mean(),x_train.std()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>train_mean,train_std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_near_zero(a,tol<span class="op">=</span><span class="fl">1e-3</span>): <span class="cf">assert</span> a.<span class="bu">abs</span>()<span class="op">&lt;</span>tol, <span class="ss">f"Near zero: </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>test_near_zero(x_train.mean())</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>test_near_zero(<span class="dv">1</span><span class="op">-</span>x_train.std())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="getting-dimensions-of-weights-of-different-layers" class="level3">
<h3 class="anchored" data-anchor-id="getting-dimensions-of-weights-of-different-layers">getting dimensions of weights of different layers</h3>
<section id="how-to-get-the-number-of-activations-of-each-layer-n-rows-of-input-m-columns-of-input-c-number-of-targetsclasses-from-the-shape-of-x_train-and-y_train" class="level4">
<h4 class="anchored" data-anchor-id="how-to-get-the-number-of-activations-of-each-layer-n-rows-of-input-m-columns-of-input-c-number-of-targetsclasses-from-the-shape-of-x_train-and-y_train"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5116">1:25:16</a> - how to get the number of activations of each layer <code>n</code> (rows of input), <code>m</code> (columns of input), <code>c</code> (number of targets/classes) from the shape of <code>x_train</code> and <code>y_train</code></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>n,m <span class="op">=</span> x_train.shape</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> y_train.<span class="bu">max</span>()<span class="op">+</span><span class="dv">1</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>n,m,c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="foundations-version" class="level2">
<h2 class="anchored" data-anchor-id="foundations-version">Foundations version</h2>
</section>
<section id="basic-architecture" class="level2">
<h2 class="anchored" data-anchor-id="basic-architecture">Basic architecture</h2>
<section id="initialize-weightsbiases-using-xavier-init-to-ensure-the-first-layers-activation-with-mean-0-and-std-1" class="level3">
<h3 class="anchored" data-anchor-id="initialize-weightsbiases-using-xavier-init-to-ensure-the-first-layers-activation-with-mean-0-and-std-1">initialize weights/biases using Xavier init to ensure the first layer’s activation with mean 0 and std 1</h3>
<section id="lets-create-a-simplest-neuralnet-with-one-hidden-layer-and-a-single-output-layer-using-mean-absolute-error-for-the-single-output-rather-than-cross-entropy-for-10-output" class="level4">
<h4 class="anchored" data-anchor-id="lets-create-a-simplest-neuralnet-with-one-hidden-layer-and-a-single-output-layer-using-mean-absolute-error-for-the-single-output-rather-than-cross-entropy-for-10-output"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5136">1:25:36</a> - Let’s create a simplest neuralnet with one hidden layer and a single output layer using mean absolute error for the single output rather than cross-entropy for 10 output;</h4>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=5128">Jump_to lesson 8 video</a></p>
</section>
<section id="how-to-use-the-matricies-with-random-number-for-creating-the-weights-and-biases-between-input-layer-and-the-hidden-layer-and-the-weights-and-biases-between-the-hidden-layer-and-the-output-layer-12646---with-only-randomly-initialized-weights-and-biases-the-activations-of-the-hidden-layer-will-have-terrible-mean-and-std-12736---the-simplifed-version-of-xavier-init-for-initializing-weights-can-ensure-the-activation-to-have-mean-0-and-std-1-and-use-test_near_zero-to-test-whether-the-activation-mean-is-near-0-and-std-is-near-1-12904---how-important-is-the-initialization-of-weights-and-biases-to-make-training-work-there-are-even-researches-to-prove-with-carful-initialization-of-weights-without-normalization-of-activations-or-inputs-can-make-training-work-for-a-model-with-even-10000-layers-and-even-one-cycle-training-and-super-convergence-are-turned-out-to-be-all-about-initializations" class="level4">
<h4 class="anchored" data-anchor-id="how-to-use-the-matricies-with-random-number-for-creating-the-weights-and-biases-between-input-layer-and-the-hidden-layer-and-the-weights-and-biases-between-the-hidden-layer-and-the-output-layer-12646---with-only-randomly-initialized-weights-and-biases-the-activations-of-the-hidden-layer-will-have-terrible-mean-and-std-12736---the-simplifed-version-of-xavier-init-for-initializing-weights-can-ensure-the-activation-to-have-mean-0-and-std-1-and-use-test_near_zero-to-test-whether-the-activation-mean-is-near-0-and-std-is-near-1-12904---how-important-is-the-initialization-of-weights-and-biases-to-make-training-work-there-are-even-researches-to-prove-with-carful-initialization-of-weights-without-normalization-of-activations-or-inputs-can-make-training-work-for-a-model-with-even-10000-layers-and-even-one-cycle-training-and-super-convergence-are-turned-out-to-be-all-about-initializations"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5175">1:26:15</a> - how to use the matricies with random number for creating the weights and biases between input layer and the hidden layer, and the weights and biases between the hidden layer and the output layer; <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5206">1:26:46</a> - with only randomly initialized weights and biases, the activations of the hidden layer will have terrible mean and std <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5256">1:27:36</a> - the simplifed version of Xavier init for initializing weights can ensure the activation to have mean 0 and std 1; and use <code>test_near_zero</code> to test whether the activation mean is near 0 and std is near 1; <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5344">1:29:04</a> - how important is the initialization of weights and biases to make training work; there are even researches to prove with carful initialization of weights without normalization of activations or inputs can make training work for a model with even 10000 layers; and even one-cycle training and super convergence are turned out to be all about initializations</h4>
<p>input shape [n, m] xx (weights [m, nh] + biases[nh]) =&gt; hidden layer (activations or neurons) [nh] hidden layer (activation layer) shape [hn] xx (weights [hn, 1] + biases [1] =&gt; output layer (neuron) [1]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># num hidden (neurons)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>nh <span class="op">=</span> <span class="dv">50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=5255">Tinker practice</a></p>
</section>
<section id="using-standared-xavier-init-to-initialize-weights-and-biases" class="level4">
<h4 class="anchored" data-anchor-id="using-standared-xavier-init-to-initialize-weights-and-biases">using standared xavier init to initialize weights and biases</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># standard xavier init</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> torch.randn(m,nh)<span class="op">/</span>math.sqrt(m)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> torch.zeros(nh)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>w2 <span class="op">=</span> torch.randn(nh,<span class="dv">1</span>)<span class="op">/</span>math.sqrt(nh)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> torch.zeros(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>test_near_zero(w1.mean())</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>test_near_zero(w1.std()<span class="op">-</span><span class="dv">1</span><span class="op">/</span>math.sqrt(m))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="x_valid-has-alread-by-normalized-to-have-mean-0-and-std-1" class="level4">
<h4 class="anchored" data-anchor-id="x_valid-has-alread-by-normalized-to-have-mean-0-and-std-1">x_valid has alread by normalized to have mean 0 and std 1</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This should be ~ (0,1) (mean,std)...</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>x_valid.mean(),x_valid.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="write-linear-layer-from-scratch" class="level4">
<h4 class="anchored" data-anchor-id="write-linear-layer-from-scratch">write linear layer from scratch</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lin(x, w, b): <span class="cf">return</span> x<span class="op">@</span>w <span class="op">+</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-mean-and-std-of-activations-of-first-layer" class="level4">
<h4 class="anchored" data-anchor-id="check-mean-and-std-of-activations-of-first-layer">check mean and std of activations of first layer</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> lin(x_valid, w1, b1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#...so should this, because we used xavier init, which is designed to do this</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>t.mean(),t.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="writing-a-linear-layer-with-relu-from-scratch" class="level3">
<h3 class="anchored" data-anchor-id="writing-a-linear-layer-with-relu-from-scratch">writing a linear layer with relu from scratch</h3>
<section id="what-is-the-first-layer-look-like-how-should-we-write-relu-function-to-maximize-the-speed-x.clamp_min0.-how-should-we-write-functions-in-pytorch-to-maximize-the-speed-in-general" class="level4">
<h4 class="anchored" data-anchor-id="what-is-the-first-layer-look-like-how-should-we-write-relu-function-to-maximize-the-speed-x.clamp_min0.-how-should-we-write-functions-in-pytorch-to-maximize-the-speed-in-general"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5409">1:30:09</a> - what is the first layer look like; how should we write relu function to maximize the speed <code>x.clamp_min(0.)</code>; how should we write functions in pytorch to maximize the speed in general;</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> relu(x): <span class="cf">return</span> x.clamp_min(<span class="fl">0.</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> relu(lin(x_valid, w1, b1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="but-relu-does-not-return-the-activation-with-mean-0-and-std-1-actually-halved-the-std-and-the-gradients-for-updating-weights-will-be-gone-when-more-layers-or-more-relus-applied-and-jeremy-explained-why-it-is-so" class="level3">
<h3 class="anchored" data-anchor-id="but-relu-does-not-return-the-activation-with-mean-0-and-std-1-actually-halved-the-std-and-the-gradients-for-updating-weights-will-be-gone-when-more-layers-or-more-relus-applied-and-jeremy-explained-why-it-is-so"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5450">1:30:50</a> - but relu does not return the activation with mean 0 and std 1, (actually halved the std, and the gradients for updating weights will be gone when more layers or more ReLUs applied) and Jeremy explained why it is so</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#...actually it really should be this!</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>t.mean(),t.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="jeremy-introduced-and-lead-us-reading-delving-deep-into-rectifiers-by-he-why-we-should-read-papers-from-competition-winners-than-other-papers-13243---jeremy-explained-rectifiers-in-the-paper-and-why-random-weightsbiases-wont-get-trained-well-using-hes-paper-and-xaviers-paper-xaviers-initialization-didnt-account-for-the-impact-of-relu-this-is-where-hes-paper-come-in-the-homework-is-to-read-this-section-2.2-of-the-hes-paper." class="level3">
<h3 class="anchored" data-anchor-id="jeremy-introduced-and-lead-us-reading-delving-deep-into-rectifiers-by-he-why-we-should-read-papers-from-competition-winners-than-other-papers-13243---jeremy-explained-rectifiers-in-the-paper-and-why-random-weightsbiases-wont-get-trained-well-using-hes-paper-and-xaviers-paper-xaviers-initialization-didnt-account-for-the-impact-of-relu-this-is-where-hes-paper-come-in-the-homework-is-to-read-this-section-2.2-of-the-hes-paper."><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5505">1:31:47</a> - Jeremy introduced and lead us reading <strong>Delving Deep into Rectifiers</strong> by He; why we should read papers from competition winners than other papers; <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5563">1:32:43</a> - Jeremy explained Rectifiers in the paper and why random weights/biases won’t get trained well using He’s paper and Xavier’s paper (Xavier’s initialization didn’t account for the impact of ReLU, this is where He’s paper come in); the homework is to read this section (2.2) of the He’s paper.</h3>
<p>From pytorch docs: <code>a: the negative slope of the rectifier used after this layer (0 for ReLU by default)</code></p>
<p><span class="math display">\[\text{std} = \sqrt{\frac{2}{(1 + a^2) \times \text{fan_in}}}\]</span></p>
<p>This was introduced in the paper that described the Imagenet-winning approach from <em>He et al</em>: <a href="https://arxiv.org/abs/1502.01852">Delving Deep into Rectifiers</a>, which was also the first paper that claimed “super-human performance” on Imagenet (and, most importantly, it introduced resnets!)</p>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=5128">Jump_to lesson 8 video</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># kaiming init / he init for relu</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> torch.randn(m,nh)<span class="op">*</span>math.sqrt(<span class="dv">2</span><span class="op">/</span>m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>w1.mean(),w1.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> relu(lin(x_valid, w1, b1))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>t.mean(),t.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="jeremy-provided-a-guidance-to-us-on-how-to-read-the-resnet-paper" class="level3">
<h3 class="anchored" data-anchor-id="jeremy-provided-a-guidance-to-us-on-how-to-read-the-resnet-paper"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5786">1:36:26</a> - Jeremy provided a guidance to us on how to read the Resnet paper</h3>
</section>
<section id="how-to-use-pytorch-function-torch.nn.init.kaiming_normal_-to-do-he-init-and-how-to-dig-into-pytorch-source-code-to-figure-out-how-to-use-those-functions-correctly-like-why-fan_out-in-init.kaiming_normal_w1-modefan_out" class="level3">
<h3 class="anchored" data-anchor-id="how-to-use-pytorch-function-torch.nn.init.kaiming_normal_-to-do-he-init-and-how-to-dig-into-pytorch-source-code-to-figure-out-how-to-use-those-functions-correctly-like-why-fan_out-in-init.kaiming_normal_w1-modefan_out"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5984">1:39:44</a> - how to use pytorch function <code>torch.nn.init.kaiming_normal_</code> to do He init and how to dig into pytorch source code to figure out how to use those functions correctly like why <code>fan_out</code> in <code>init.kaiming_normal_(w1, mode='fan_out')</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.nn <span class="im">import</span> init</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> torch.zeros(m,nh)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>init.kaiming_normal_(w1, mode<span class="op">=</span><span class="st">'fan_out'</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> relu(lin(x_valid, w1, b1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>init.kaiming_normal_??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>w1.mean(),w1.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>t.mean(),t.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>w1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>torch.nn.Linear(m,nh).weight.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>torch.nn.Linear.forward??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>torch.nn.functional.linear??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-find-and-read-source-code-of-convolutional-layer-in-pytorch-and-why-it-is-a-good-idea-to-put-the-url-of-the-paper-you-are-implementing-in-the-source-code" class="level3">
<h3 class="anchored" data-anchor-id="how-to-find-and-read-source-code-of-convolutional-layer-in-pytorch-and-why-it-is-a-good-idea-to-put-the-url-of-the-paper-you-are-implementing-in-the-source-code"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6176">1:42:56</a> - how to find and read source code of convolutional layer in pytorch and why it is a good idea to put the url of the paper you are implementing in the source code</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>torch.nn.Conv2d??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>torch.nn.modules.conv._ConvNd.reset_parameters??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="jeremy-noticed-a-problem-of-the-he-initialization-on-the-value-of-mean-and-explained-why-so-then-he-tried-to-a-simple-but-natural-method-to-bring-the-mean-to-0-and-the-result-seems-very-good-and-ended-here-at-13944-14435---how-much-better-does-jeremys-tweaked-relu-work-for-getting-activation-mean-to-0-and-std-to-0.8-rather-than-previously-0.7" class="level3">
<h3 class="anchored" data-anchor-id="jeremy-noticed-a-problem-of-the-he-initialization-on-the-value-of-mean-and-explained-why-so-then-he-tried-to-a-simple-but-natural-method-to-bring-the-mean-to-0-and-the-result-seems-very-good-and-ended-here-at-13944-14435---how-much-better-does-jeremys-tweaked-relu-work-for-getting-activation-mean-to-0-and-std-to-0.8-rather-than-previously-0.7"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5935">1:38:55</a> - Jeremy noticed a problem of the He initialization on the value of mean and explained why so; then he tried to a simple but natural method to bring the mean to 0 and the result seems very good and ended here at <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=5984">1:39:44</a> <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6275">1:44:35</a> - how much better does Jeremy’s tweaked ReLU work for getting activation mean to 0 and std to 0.8 rather than previously 0.7</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># what if...?</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> relu(x): <span class="cf">return</span> x.clamp_min(<span class="fl">0.</span>) <span class="op">-</span> <span class="fl">0.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># kaiming init / he init for relu</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> torch.randn(m,nh)<span class="op">*</span>math.sqrt(<span class="fl">2.</span><span class="op">/</span>m )</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> relu(lin(x_valid, w1, b1))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>t1.mean(),t1.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-build-our-model-model-using-the-functions-lin-relu-we-built-above-how-to-test-how-fast-it-is-to-run-and-how-to-verify-the-shape-of-the-model-output-to-be-correct" class="level3">
<h3 class="anchored" data-anchor-id="how-to-build-our-model-model-using-the-functions-lin-relu-we-built-above-how-to-test-how-fast-it-is-to-run-and-how-to-verify-the-shape-of-the-model-output-to-be-correct"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6328">1:45:28</a> - how to build our model <code>model</code> using the functions <code>lin</code>, <code>relu</code> we built above; how to test how fast it is to run; and how to verify the shape of the model output to be correct</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model(xb):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    l1 <span class="op">=</span> lin(xb, w1, b1)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    l2 <span class="op">=</span> relu(l1)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    l3 <span class="op">=</span> lin(l2, w2, b2)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> l3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> model(x_valid).shape<span class="op">==</span>torch.Size([x_valid.shape[<span class="dv">0</span>],<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="loss-function-mse" class="level2">
<h2 class="anchored" data-anchor-id="loss-function-mse">Loss function: MSE</h2>
<section id="how-to-write-mean-squared-error-as-our-loss-function-we-never-use-it-but-only-use-mse-as-a-starting-point-for-our-loss-how-to-squeeze-a-tensor-with-shape-n-1-to-just-shape-n-using-output.squeeze-1" class="level3">
<h3 class="anchored" data-anchor-id="how-to-write-mean-squared-error-as-our-loss-function-we-never-use-it-but-only-use-mse-as-a-starting-point-for-our-loss-how-to-squeeze-a-tensor-with-shape-n-1-to-just-shape-n-using-output.squeeze-1"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6375">1:46:15</a> - how to write mean squared error as our loss function (we never use it but only use mse as a starting point for our loss); how to squeeze a tensor with shape [n, 1] to just shape [n] using <code>output.squeeze(-1)</code></h3>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=6372">Jump_to lesson 8 video</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>model(x_valid).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need <code>squeeze()</code> to get rid of that trailing (,1), in order to use <code>mse</code>. (Of course, <code>mse</code> is not a suitable loss function for multi-class classification; we’ll use a better loss function soon. We’ll use <code>mse</code> for now to keep things simple.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mse(output, targ): <span class="cf">return</span> (output.squeeze(<span class="op">-</span><span class="dv">1</span>) <span class="op">-</span> targ).<span class="bu">pow</span>(<span class="dv">2</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>y_train,y_valid <span class="op">=</span> y_train.<span class="bu">float</span>(),y_valid.<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> model(x_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>mse(preds, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="gradients-and-backward-pass" class="level2">
<h2 class="anchored" data-anchor-id="gradients-and-backward-pass">Gradients and backward pass</h2>
<section id="jeremy-has-given-us-all-the-matrix-calculus-we-need-for-deep-learning-for-total-beginners-14912---how-to-understand-and-do-the-chain-rule-in-terms-of-getting-gradients-with-respect-to-params-of-our-model-and-how-to-understand-derivative-in-plain-language-15256---how-to-calculuate-the-derivate-or-gradient-with-respect-to-the-output-of-previous-layer-or-funcs-mse-lin-relu" class="level3">
<h3 class="anchored" data-anchor-id="jeremy-has-given-us-all-the-matrix-calculus-we-need-for-deep-learning-for-total-beginners-14912---how-to-understand-and-do-the-chain-rule-in-terms-of-getting-gradients-with-respect-to-params-of-our-model-and-how-to-understand-derivative-in-plain-language-15256---how-to-calculuate-the-derivate-or-gradient-with-respect-to-the-output-of-previous-layer-or-funcs-mse-lin-relu"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6480">1:48:00</a> - Jeremy has given us all the <a href="https://explained.ai/matrix-calculus/index.html">matrix calculus</a> we need for deep learning for total beginners; <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6552">1:49:12</a> - how to understand and do the chain rule in terms of getting gradients with respect to params of our model and how to understand derivative in plain language; <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6776">1:52:56</a> - how to calculuate the derivate or gradient with respect to the output of previous layer or funcs ( <code>mse</code>, <code>lin</code>, <code>relu</code> )</h3>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=6493">Jump_to lesson 8 video</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mse_grad(inp, targ): </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grad of loss with respect to output of previous layer</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    inp.g <span class="op">=</span> <span class="fl">2.</span> <span class="op">*</span> (inp.squeeze() <span class="op">-</span> targ).unsqueeze(<span class="op">-</span><span class="dv">1</span>) <span class="op">/</span> inp.shape[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> relu_grad(inp, out):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grad of relu with respect to input activations</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    inp.g <span class="op">=</span> (inp<span class="op">&gt;</span><span class="dv">0</span>).<span class="bu">float</span>() <span class="op">*</span> out.g</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lin_grad(inp, out, w, b):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grad of matmul with respect to input</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    inp.g <span class="op">=</span> out.g <span class="op">@</span> w.t()</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    w.g <span class="op">=</span> (inp.unsqueeze(<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> out.g.unsqueeze(<span class="dv">1</span>)).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    b.g <span class="op">=</span> out.g.<span class="bu">sum</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-put-forward-pass-and-backward-pass-into-one-function-foward_and_backward-and-backward-pass-is-the-chain-rule-people-who-say-no-are-liars-and-saving-the-gradients-as-well" class="level3">
<h3 class="anchored" data-anchor-id="how-to-put-forward-pass-and-backward-pass-into-one-function-foward_and_backward-and-backward-pass-is-the-chain-rule-people-who-say-no-are-liars-and-saving-the-gradients-as-well"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=6922">1:55:22</a> - how to put forward pass and backward pass into one function <code>foward_and_backward</code>; and backward pass is the chain rule (people who say No are liars) and saving the gradients as well;</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_and_backward(inp, targ):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># forward pass:</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    l1 <span class="op">=</span> inp <span class="op">@</span> w1 <span class="op">+</span> b1</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    l2 <span class="op">=</span> relu(l1)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> l2 <span class="op">@</span> w2 <span class="op">+</span> b2</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we don't actually need the loss in backward!</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> mse(out, targ)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># backward pass:</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    mse_grad(out, targ)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    lin_grad(l2, out, w2, b2)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    relu_grad(l1, l2)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    lin_grad(inp, l1, w1, b1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>forward_and_backward(x_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-to-use-pytorchs-gradient-calculation-functions-to-test-whether-our-own-gradients-are-calculated-correctly" class="level3">
<h3 class="anchored" data-anchor-id="how-to-use-pytorchs-gradient-calculation-functions-to-test-whether-our-own-gradients-are-calculated-correctly"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=7001">1:56:41</a> - how to use pytorch’s gradient calculation functions to test whether our own gradients are calculated correctly;</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save for testing against later</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>w1g <span class="op">=</span> w1.g.clone()</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>w2g <span class="op">=</span> w2.g.clone()</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>b1g <span class="op">=</span> b1.g.clone()</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>b2g <span class="op">=</span> b2.g.clone()</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>ig  <span class="op">=</span> x_train.g.clone()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We cheat a little bit and use PyTorch autograd to check our results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>xt2 <span class="op">=</span> x_train.clone().requires_grad_(<span class="va">True</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>w12 <span class="op">=</span> w1.clone().requires_grad_(<span class="va">True</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>w22 <span class="op">=</span> w2.clone().requires_grad_(<span class="va">True</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>b12 <span class="op">=</span> b1.clone().requires_grad_(<span class="va">True</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>b22 <span class="op">=</span> b2.clone().requires_grad_(<span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward(inp, targ):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># forward pass:</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    l1 <span class="op">=</span> inp <span class="op">@</span> w12 <span class="op">+</span> b12</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    l2 <span class="op">=</span> relu(l1)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> l2 <span class="op">@</span> w22 <span class="op">+</span> b22</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we don't actually need the loss in backward!</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mse(out, targ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> forward(xt2, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>test_near(w22.grad, w2g)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>test_near(b22.grad, b2g)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>test_near(w12.grad, w1g)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>test_near(b12.grad, b1g)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>test_near(xt2.grad, ig )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="refactor-model" class="level2">
<h2 class="anchored" data-anchor-id="refactor-model">Refactor model</h2>
</section>
<section id="layers-as-classes" class="level2">
<h2 class="anchored" data-anchor-id="layers-as-classes">Layers as classes</h2>
<section id="how-to-refactor-the-previous-funcs-into-classes-after-jeremy-has-done-the-refactory-work-it-becomes-almost-identical-to-pytorch-api" class="level3">
<h3 class="anchored" data-anchor-id="how-to-refactor-the-previous-funcs-into-classes-after-jeremy-has-done-the-refactory-work-it-becomes-almost-identical-to-pytorch-api"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=7096">1:58:16</a> - how to refactor the previous funcs into classes; After Jeremy has done the refactory work, it becomes almost identical to pytorch api</h3>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=7112">Jump_to lesson 8 video</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Relu():</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp):</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inp <span class="op">=</span> inp</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out <span class="op">=</span> inp.clamp_min(<span class="fl">0.</span>)<span class="op">-</span><span class="fl">0.5</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(<span class="va">self</span>): <span class="va">self</span>.inp.g <span class="op">=</span> (<span class="va">self</span>.inp<span class="op">&gt;</span><span class="dv">0</span>).<span class="bu">float</span>() <span class="op">*</span> <span class="va">self</span>.out.g</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Lin():</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, w, b): <span class="va">self</span>.w,<span class="va">self</span>.b <span class="op">=</span> w,b</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp):</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inp <span class="op">=</span> inp</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out <span class="op">=</span> inp<span class="op">@</span>self.w <span class="op">+</span> <span class="va">self</span>.b</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(<span class="va">self</span>):</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inp.g <span class="op">=</span> <span class="va">self</span>.out.g <span class="op">@</span> <span class="va">self</span>.w.t()</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Creating a giant outer product, just to sum it, is inefficient!</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.w.g <span class="op">=</span> (<span class="va">self</span>.inp.unsqueeze(<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> <span class="va">self</span>.out.g.unsqueeze(<span class="dv">1</span>)).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.b.g <span class="op">=</span> <span class="va">self</span>.out.g.<span class="bu">sum</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Mse():</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp, targ):</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inp <span class="op">=</span> inp</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.targ <span class="op">=</span> targ</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out <span class="op">=</span> (inp.squeeze() <span class="op">-</span> targ).<span class="bu">pow</span>(<span class="dv">2</span>).mean()</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(<span class="va">self</span>):</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inp.g <span class="op">=</span> <span class="fl">2.</span> <span class="op">*</span> (<span class="va">self</span>.inp.squeeze() <span class="op">-</span> <span class="va">self</span>.targ).unsqueeze(<span class="op">-</span><span class="dv">1</span>) <span class="op">/</span> <span class="va">self</span>.targ.shape[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model():</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, w1, b1, w2, b2):</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layers <span class="op">=</span> [Lin(w1,b1), Relu(), Lin(w2,b2)]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loss <span class="op">=</span> Mse()</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x, targ):</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers: x <span class="op">=</span> l(x)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.loss(x, targ)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(<span class="va">self</span>):</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loss.backward()</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> l <span class="kw">in</span> <span class="bu">reversed</span>(<span class="va">self</span>.layers): l.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>w1.g,b1.g,w2.g,b2.g <span class="op">=</span> [<span class="va">None</span>]<span class="op">*</span><span class="dv">4</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(w1, b1, w2, b2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>test_near(w2g, w2.g)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>test_near(b2g, b2.g)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>test_near(w1g, w1.g)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>test_near(b1g, b1.g)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>test_near(ig, x_train.g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="module.forward" class="level2">
<h2 class="anchored" data-anchor-id="module.forward">Module.forward()</h2>
<section id="how-to-remove-duplicated-codes-by-adding-another-class-module-and-using-einsum-and-as-a-result-our-refactor-codes-become-identical-to-pytorch-api-this-step-truly-help-make-sense-pytorch-api" class="level3">
<h3 class="anchored" data-anchor-id="how-to-remove-duplicated-codes-by-adding-another-class-module-and-using-einsum-and-as-a-result-our-refactor-codes-become-identical-to-pytorch-api-this-step-truly-help-make-sense-pytorch-api"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=7356">2:02:36</a> - how to remove duplicated codes by adding another class Module and using <code>einsum</code>, and as a result, our refactor codes become identical to pytorch api; this step truly help make sense pytorch api</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Module():</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, <span class="op">*</span>args):</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.args <span class="op">=</span> args</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out <span class="op">=</span> <span class="va">self</span>.forward(<span class="op">*</span>args)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>): <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">'not implemented'</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(<span class="va">self</span>): <span class="va">self</span>.bwd(<span class="va">self</span>.out, <span class="op">*</span><span class="va">self</span>.args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Relu(Module):</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inp): <span class="cf">return</span> inp.clamp_min(<span class="fl">0.</span>)<span class="op">-</span><span class="fl">0.5</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bwd(<span class="va">self</span>, out, inp): inp.g <span class="op">=</span> (inp<span class="op">&gt;</span><span class="dv">0</span>).<span class="bu">float</span>() <span class="op">*</span> out.g</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Lin(Module):</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, w, b): <span class="va">self</span>.w,<span class="va">self</span>.b <span class="op">=</span> w,b</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inp): <span class="cf">return</span> inp<span class="op">@</span>self.w <span class="op">+</span> <span class="va">self</span>.b</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bwd(<span class="va">self</span>, out, inp):</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        inp.g <span class="op">=</span> out.g <span class="op">@</span> <span class="va">self</span>.w.t()</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.w.g <span class="op">=</span> torch.einsum(<span class="st">"bi,bj-&gt;ij"</span>, inp, out.g)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.b.g <span class="op">=</span> out.g.<span class="bu">sum</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Mse(Module):</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward (<span class="va">self</span>, inp, targ): <span class="cf">return</span> (inp.squeeze() <span class="op">-</span> targ).<span class="bu">pow</span>(<span class="dv">2</span>).mean()</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bwd(<span class="va">self</span>, out, inp, targ): inp.g <span class="op">=</span> <span class="dv">2</span><span class="op">*</span>(inp.squeeze()<span class="op">-</span>targ).unsqueeze(<span class="op">-</span><span class="dv">1</span>) <span class="op">/</span> targ.shape[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model():</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layers <span class="op">=</span> [Lin(w1,b1), Relu(), Lin(w2,b2)]</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loss <span class="op">=</span> Mse()</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x, targ):</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers: x <span class="op">=</span> l(x)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.loss(x, targ)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(<span class="va">self</span>):</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loss.backward()</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> l <span class="kw">in</span> <span class="bu">reversed</span>(<span class="va">self</span>.layers): l.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>w1.g,b1.g,w2.g,b2.g <span class="op">=</span> [<span class="va">None</span>]<span class="op">*</span><span class="dv">4</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>test_near(w2g, w2.g)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>test_near(b2g, b2.g)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>test_near(w1g, w1.g)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>test_near(b1g, b1.g)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>test_near(ig, x_train.g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="without-einsum" class="level2">
<h2 class="anchored" data-anchor-id="without-einsum">Without einsum</h2>
<section id="how-to-replace-einsum-with-pure-matrix-multiplication-with-and-as-a-result-our-own-code-from-scratch-is-as-fast-as-pytorch-20544-plan-for-the-next-lesson" class="level3">
<h3 class="anchored" data-anchor-id="how-to-replace-einsum-with-pure-matrix-multiplication-with-and-as-a-result-our-own-code-from-scratch-is-as-fast-as-pytorch-20544-plan-for-the-next-lesson"><a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=7484">2:04:44</a> - how to replace <code>einsum</code> with pure matrix multiplication with <code>@</code>; and as a result, our own code from scratch is as fast as pytorch <a href="https://youtu.be/4u8FxNEDUeg?list=PLfYUBJiXbdtTIdtE1U8qgyxo4Jy2Y91uj&amp;t=7544">2:05:44</a> plan for the next lesson</h3>
<p><a href="https://course19.fast.ai/videos/?lesson=8&amp;t=7484">Jump_to lesson 8 video</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Lin(Module):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, w, b): <span class="va">self</span>.w,<span class="va">self</span>.b <span class="op">=</span> w,b</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inp): <span class="cf">return</span> inp<span class="op">@</span>self.w <span class="op">+</span> <span class="va">self</span>.b</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bwd(<span class="va">self</span>, out, inp):</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        inp.g <span class="op">=</span> out.g <span class="op">@</span> <span class="va">self</span>.w.t()</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.w.g <span class="op">=</span> inp.t() <span class="op">@</span> out.g</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.b.g <span class="op">=</span> out.g.<span class="bu">sum</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>w1.g,b1.g,w2.g,b2.g <span class="op">=</span> [<span class="va">None</span>]<span class="op">*</span><span class="dv">4</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>test_near(w2g, w2.g)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>test_near(b2g, b2.g)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>test_near(w1g, w1.g)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>test_near(b1g, b1.g)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>test_near(ig, x_train.g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="nn.linear-and-nn.module" class="level3">
<h3 class="anchored" data-anchor-id="nn.linear-and-nn.module">nn.Linear and nn.Module</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#export</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_in, nh, n_out):</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layers <span class="op">=</span> [nn.Linear(n_in,nh), nn.ReLU(), nn.Linear(nh,n_out)]</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loss <span class="op">=</span> mse</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x, targ):</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers: x <span class="op">=</span> l(x)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.loss(x.squeeze(), targ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(m, nh, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>.<span class="op">/</span>notebook2script.py <span class="dv">0</span><span class="er">2_fully_connected</span>.ipynb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>